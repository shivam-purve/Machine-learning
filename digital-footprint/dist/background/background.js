let i=null,o=null,a=null,s=!1;const m="https://dummy.server.com/session",p="https://dummy.server.com/html";chrome.runtime.onInstalled.addListener(()=>{chrome.storage.local.get(["events","settings"],e=>{e.events||chrome.storage.local.set({events:[]}),e.settings||chrome.storage.local.set({settings:{contentScanning:!1,excludeList:[]}})})});function l(e){chrome.storage.local.get({events:[]},t=>{const n=t.events||[],r=Date.now()-336*60*60*1e3,c=n.filter(f=>f.ts>=r);c.push(e),chrome.storage.local.set({events:c})})}async function y(e,t,n){const r=n-t;try{await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,startTime:t,endTime:n,duration:r})})}catch(c){console.warn("SESSION API ERROR",c)}}async function h(e,t){try{await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,html:t})})}catch(n){console.warn("HTML API ERROR",n)}}function g(e){return new Promise(t=>{chrome.scripting.executeScript({target:{tabId:e},files:["content/contentScript.js"]},()=>{chrome.tabs.sendMessage(e,{type:"request_full_text"},n=>t(n?.text||""))})})}async function d(){if(!i||!o||!a)return;const e=Date.now(),t=i,n=a,r=await g(t);y(n,o,e),h(n,r),l({type:"session_end",url:n,duration:e-o,ts:e}),i=null,o=null,a=null}function u(e){d(),!(!e||!e.url)&&(e.url.startsWith("chrome://")||e.url.startsWith("chrome-extension://")||chrome.storage.local.get({settings:{excludeList:[]}},t=>{(t.settings.excludeList||[]).some(r=>e.url.includes(r))||(i=e.id,a=e.url,o=Date.now(),l({type:"session_start",url:e.url,ts:Date.now()}))}))}chrome.tabs.onActivated.addListener(async e=>{if(s)return;const t=await chrome.tabs.get(e.tabId);u(t)});chrome.windows.onFocusChanged.addListener(e=>{s||(e===chrome.windows.WINDOW_ID_NONE?d():chrome.tabs.query({active:!0,windowId:e},t=>{t[0]&&u(t[0])}))});chrome.tabs.onUpdated.addListener((e,t,n)=>{s||e===i&&t.status==="complete"&&u(n)});chrome.runtime.onMessage.addListener((e,t,n)=>{if(e?.type){if(e.type==="pause")return s=!0,d(),n({paused:!0}),!0;if(e.type==="resume")return s=!1,chrome.tabs.query({active:!0,currentWindow:!0},r=>{r[0]&&u(r[0])}),n({paused:!1}),!0;if(e.type==="getStatus")return n({paused:s}),!0;if(e.type==="engagement")return l({type:"engagement",url:t.tab?.url||"",data:e.data,ts:Date.now()}),n({ok:!0}),!0;if(e.type==="page_html")return h(t.tab?.url||"",e.text),n({ok:!0}),!0}});
